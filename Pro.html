<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mars Rover Recycler</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; }

    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 8px;
    }

    #machineUI {
      display: none;
      position: absolute;
      top: 20%;
      left: 30%;
      width: 40%;
      background: rgba(0,0,0,0.9);
      border: 2px solid #fff;
      border-radius: 12px;
      padding: 20px;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }

    #machineUI button {
      margin: 5px;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="ui">
    <p><b>Controls:</b> WASD / Arrow keys to move rover, SPACE to collect waste, M to open/close machine</p>
    <p id="inventory">Inventory: (empty)</p>
  </div>

  <div id="machineUI">
    <h2>Recycling Machine</h2>
    <div id="inventoryList"></div>
    <button onclick="convertWaste('plastic')">Convert Plastic → Filament</button>
    <button onclick="convertWaste('metal')">Convert Metal → Ingots</button>
    <button onclick="convertWaste('organic')">Convert Organic → Fuel</button>
    <p id"conversionLog"></p>
    <button onclick="closeMachine()">Close Machine</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

  <script>
    let scene, camera, renderer, rover;
    let wastes = [];
    let keys = {};
    let inventory = { plastic:0, metal:0, organic:0 };
    let inMachineView = false;

    const loader = new THREE.TextureLoader();

    // Load textures (make sure these are in same GitHub repo folder!)
    const marsTexture = loader.load('mars_ground.jpg');
    const plasticTexture = loader.load('plastic.jpg');
    const metalTexture = loader.load('metal.jpg');
    const organicTexture = loader.load('organic.jpg');

    init();
    animate();

      // ========== Scene setup ==========
  const canvas=document.getElementById('gameCanvas');
  const renderer=new THREE.WebGLRenderer({canvas,antialias:true});renderer.setPixelRatio(window.devicePixelRatio);renderer.setSize(window.innerWidth,window.innerHeight);
  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0,8,12);
  camera.lookAt(0,0,0);

  // lights
  const hemi=new THREE.HemisphereLight(0xffeedd,0x404040,1.0);scene.add(hemi);
  const dir=new THREE.DirectionalLight(0xffe0c0,0.8);dir.position.set(5,10,2);scene.add(dir);

  // ground
  const groundGeo=new THREE.PlaneGeometry(200,200,64,64);
  const groundMat=new THREE.MeshStandardMaterial({map:makeMarsTexture(),roughness:1});
  const ground=new THREE.Mesh(groundGeo,groundMat);ground.rotation.x=-Math.PI/2;scene.add(ground);

  // simple hills by displacing vertices
  for(let i=0;i<groundGeo.attributes.position.count;i++){const y=(Math.sin(i*0.1)*0.08 + (Math.random()-0.5)*0.03);groundGeo.attributes.position.setY(i,y)}
  groundGeo.computeVertexNormals();

  // Rover (player)
  const rover=new THREE.Group();
  const body=new THREE.Mesh(new THREE.BoxGeometry(1.6,0.6,1),new THREE.MeshStandardMaterial({color:'#d15b3a',metalness:0.3,roughness:0.6}));body.position.y=0.5;rover.add(body);
  const wheelGeom=new THREE.CylinderGeometry(0.25,0.25,0.4,12);
  for(let i=-1;i<=1;i+=2){for(let j=-1;j<=1;j+=2){const w=new THREE.Mesh(wheelGeom,new THREE.MeshStandardMaterial({color:'#333'}));w.rotation.z=Math.PI/2;w.position.set(0.6*i,0.25,0.45*j);rover.add(w)}}
  rover.position.set(0,0,0);scene.add(rover);

  // Waste items
  const wastes=[]; // {mesh,type,pos}
  const types=['plastic','metal','organic'];
  function spawnWaste(n=25){for(let i=0;i<n;i++){const t=types[Math.floor(Math.random()*types.length)];let mesh; if(t==='plastic'){mesh=new THREE.Mesh(new THREE.SphereGeometry(0.25,12,12),new THREE.MeshStandardMaterial({map:makePlasticTexture('#2b7dff'),metalness:0.1,roughness:0.6}))}
    else if(t==='metal'){mesh=new THREE.Mesh(new THREE.BoxGeometry(0.4,0.4,0.4),new THREE.MeshStandardMaterial({map:makeMetalTexture(),metalness:0.9,roughness:0.35}))}
    else {mesh=new THREE.Mesh(new THREE.DodecahedronGeometry(0.32,0),new THREE.MeshStandardMaterial({map:makeOrganicTexture(),metalness:0.05,roughness:0.9}))}
    const x=(Math.random()-0.5)*80; const z=(Math.random()-0.5)*80; mesh.position.set(x,0.2,z); mesh.userData={type:t, collected:false}; scene.add(mesh); wastes.push(mesh);} }
  spawnWaste(32);

  // simple UI inventory
  const inventory=[]; // array of {type}
  const inventoryEl=document.getElementById('inventory');
  function refreshInventory(){inventoryEl.innerHTML=''; for(let i=0;i<6;i++){const s=document.createElement('div');s.className='slot'; if(inventory[i]){s.textContent=inventory[i].type; s.draggable=true; s.dataset.index=i; s.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',i)})}
      inventoryEl.appendChild(s)} }
  refreshInventory();

  // Machine UI
  const machineUI=document.getElementById('machineUI');
  const machineSlotsEl=document.getElementById('machineSlots');
  const machineLog=document.getElementById('machineLog');
  const machineSlots=[null,null, null]; // up to 3 slots
  function refreshMachineSlots(){machineSlotsEl.innerHTML=''; for(let i=0;i<3;i++){const slot=document.createElement('div');slot.className='slot';slot.style.width='72px';slot.style.height='72px';slot.dataset.index=i; if(machineSlots[i]){slot.textContent=machineSlots[i].type}
      slot.addEventListener('dragover',e=>e.preventDefault()); slot.addEventListener('drop',e=>{e.preventDefault();const fromIdx=parseInt(e.dataTransfer.getData('text/plain')); if(!isNaN(fromIdx) && inventory[fromIdx]){machineSlots[i]=inventory[fromIdx]; inventory.splice(fromIdx,1); refreshInventory(); refreshMachineSlots()}});
      machineSlotsEl.appendChild(slot)} }
  refreshMachineSlots();

  document.getElementById('convertBtn').addEventListener('click',()=>{
    // convert each slot
    for(let i=0;i<machineSlots.length;i++){const it=machineSlots[i]; if(!it) continue; if(it.type==='plastic'){machineLog.innerHTML+=("Plastic → Filament created!<br>");}
      else if(it.type==='metal'){machineLog.innerHTML+=("Metal → Ingot formed!<br>");}
      else if(it.type==='organic'){machineLog.innerHTML+=("Organic → Fuel refined!<br>");}
      machineSlots[i]=null;}
    refreshMachineSlots();
  });
  document.getElementById('backBtn').addEventListener('click',()=>{setMode('explore')});

  // Machine front model (in scene) - placed aside
  const machine=new THREE.Group();
  const machineBase=new THREE.Mesh(new THREE.BoxGeometry(3,1.2,1.5),new THREE.MeshStandardMaterial({color:'#333',metalness:0.2,roughness:0.6}));machineBase.position.y=0.6;machine.add(machineBase);
  const machineTop=new THREE.Mesh(new THREE.BoxGeometry(2.4,1.6,0.6),new THREE.MeshStandardMaterial({color:'#222',metalness:0.6,roughness:0.3}));machineTop.position.set(0,1.5,0);machine.add(machineTop);
  machine.position.set(12,0,0);scene.add(machine);

  // modes
  let mode='explore';
  function setMode(m){mode=m; if(m==='machine'){ // camera jumps to front of machine and open UI
      camera.position.set(12,3.2,6); camera.lookAt(12,1,0); machineUI.style.display='block'; document.getElementById('prompt').style.display='none';
    } else {camera.position.set(rover.position.x,8,rover.position.z+12);camera.lookAt(rover.position.x,0,rover.position.z); machineUI.style.display='none'; document.getElementById('prompt').style.display='block'} }

  // simple movement
  const keys={}; window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true; if(e.key===' '){collectNearby()} if(e.key.toLowerCase()==='m'){setMode(mode==='explore'?'machine':'explore')}});
  window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false});

  function collectNearby(){// pick any waste within 1.2m and add to inventory
    for(let i=0;i<wastes.length;i++){const w=wastes[i]; if(w.userData.collected) continue; const d=w.position.distanceTo(rover.position); if(d<1.5){w.userData.collected=true; scene.remove(w); inventory.push({type:w.userData.type}); refreshInventory(); break}} }

  // simple collision / keep rover on ground
  function update(dt){const speed=dt*4; let moved=false; if(keys['arrowup']||keys['w']){rover.position.z-=speed;moved=true} if(keys['arrowdown']||keys['s']){rover.position.z+=speed;moved=true} if(keys['arrowleft']||keys['a']){rover.position.x-=speed;moved=true} if(keys['arrowright']||keys['d']){rover.position.x+=speed;moved=true}
    if(moved){camera.position.x=rover.position.x;camera.position.z=rover.position.z+12; camera.lookAt(rover.position.x,0,rover.position.z)}
  }

  // drag support from inventory to machine UI (already uses HTML drag)

  // animate loop
  let last=performance.now();
  function loop(t){const dt=(t-last)/1000; last=t; update(dt); renderer.render(scene,camera); requestAnimationFrame(loop)} requestAnimationFrame(loop);

  // resize
  window.addEventListener('resize',()=>{renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix()});

  // touch: show simple on-screen joystick for mobile (tiny)
  // (Not full joystick implementation — tap space area to collect on mobile)
  canvas.addEventListener('touchstart',e=>{if(e.touches.length===1){collectNearby()}});

  // quick tips in console
  console.log('Mars Rover Recycler demo loaded. Controls: WASD/arrows to move, Space to collect, M to open machine.');
  </script>
</body>
</html>      
